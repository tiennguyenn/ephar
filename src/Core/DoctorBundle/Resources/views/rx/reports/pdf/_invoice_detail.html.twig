<div class="content">
  <div class="container">
    <h2 class="sub-title">{{ title }}</h2>
    <table class="table-data table-multi-line">
      <thead>
        <tr>
          <th align="left" valign="bottom" width="16%" class="border-bottom">Date of <br> Transaction</th>
          <th align="left" valign="bottom" width="16%" class="border-bottom">Order ID</th>
          <th align="left" valign="bottom" width="26%" class="border-bottom">Patient <br> Name and Code</th>
          <th align="left" valign="bottom" class="border-right border-bottom" width="30%">Prescription Details</th>
          <th align="right" valign="bottom" width="12%" class="border-bottom">Amount ({{ currencyCode }})</th>
        </tr>
      </thead>  
      <tbody>
        {% if data is defined %}
          {% set col3SubtotalArea = 0 %}

          {% for item in data %}
            {% set index = loop.index %}
            {% set last = loop.last %}
            <tr>
              <td valign="top" width="16%">{{ item.rx.paidOn|date('d M Y') }}</td>
              <td valign="top" width="16%">{{ item.rx.orderNumber }}</td>
              <td valign="top" width="26%">
                 
                  {{ item.rx.patientCode }}
                  {% if item.rx.taxIncome is not null %}<br>Tax ID: {{ item.rx.taxId }}{% endif %}</td>
              <td colspan="2" class="subdata-wrap">
                <table class="table-subdata">
                    {% set col3SubTotal = 0 %}
                    {% for rxLine in item.presDetail %}
                      {% if rxLine.lineType == 2 and rxLine.hasRxReviewFee == true %}
                        {% if platform_share_fee %}
                        <tr>
                            <td class="border-right" width="71.5%">GMedes Admin Service Fee Per Prescription</td>

                            <td width="28.5%" align="right" {% if (rxLine.listPrice - rxLine.doctorServiceFee) < 0 %}class="txt-red"{% endif %}>{{ (rxLine.listPrice - rxLine.doctorServiceFee)|number_format(2, '.', ',') }}</td>

                            {% set col3SubTotal = col3SubTotal + (rxLine.listPrice - rxLine.doctorServiceFee) %}
                        </tr>
                        {% else %}
                        <tr>
                            <td class="border-right" width="71.5%">Doctor's Fees (Prescribing Fee)</td>

                            <td width="28.5%" align="right" {% if (rxLine.listPrice - rxLine.doctorServiceFee) < 0 %}class="txt-red"{% endif %}>{{ (rxLine.listPrice - rxLine.doctorServiceFee)|number_format(2, '.', ',') }}</td>

                            {% set col3SubTotal = col3SubTotal + (rxLine.listPrice - rxLine.doctorServiceFee) %}
                        </tr>
                        {% endif %}
                      {% elseif rxLine.lineType == 1 %}
                        <tr>
                              <td class="border-right" width="71.5%">{{ rxLine.name }}</td>
                              <td width="28.5%" align="right" {% if (rxLine.listPrice - rxLine.doctorMedicineFee) < 0 %} class='txt-red'{% endif %}>{{ (rxLine.listPrice - rxLine.doctorMedicineFee)|number_format(2, '.', ',') }}</td>

                              {% set col3SubTotal = col3SubTotal + (rxLine.listPrice - rxLine.doctorMedicineFee) %}
                        </tr>
                      {% endif %}
                        </tr>
                    {% endfor %}
                    <tr>
                      <td class="border-right">Shipping and Handling Fee</td>
                      <td align="right">{{ item.rx.shippingList[0]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% if type == 'overSea' and item.rx.customCAF[4] * 1 > 0 %}
                      <tr>
                        <td class="border-right">Customs Clearance Admin Fee - {{item.rx.countryCode == 'ID' ? 'INDO' : item.rx.countryCode}}</td>
                        <td align="right">{{ item.rx.customCAF[4]|number_format(2, '.', ',') }}</td>
                      </tr>
                       {% set col3SubTotal = col3SubTotal + item.rx.customCAF[4] %}
                    {% endif %}
                    {% if item.rx.customsTax[0] * 1 > 0 %}
                        {% if item.rx.taxIncome is not null or item.rx.taxIncomeWithoutTax is not null %}
                            <tr>
                                <td class="border-right">BM - Import Duty</td>
                                <td align="right">{{ item.rx.importDuty }}</td>
                            </tr>
                            <tr>
                                <td class="border-right">PPN - VAT</td>
                                <td align="right">{{ item.rx.taxVat }}</td>
                            </tr>
                            {% if item.rx.taxIncome is not null %}
                                {% set label = 'PPH1 - Tax on Import (for individuals with TAX ID)' %}
                                {% set pph = item.rx.taxIncome %}
                            {% else %}
                                {% set label = 'PPH2 - Tax on Import (for individuals without TAX ID)' %}
                                {% set pph = item.rx.taxIncomeWithoutTax %}
                            {% endif %}
                            <tr>
                                <td class="border-right">{{ label }}</td>
                                <td align="right">{{ pph }}</td>
                            </tr>
                            {% set col3SubTotal = col3SubTotal + pph + item.rx.taxVat + item.rx.importDuty %}
                        {% else %}
                          <tr>
                            <td class="border-right">{{ item.rx.customsTaxName }}</td>
                            <td align="right">{{ item.rx.customsTax[0]|number_format(2, '.', ',') }}</td>
                          </tr>
                        {% set col3SubTotal = col3SubTotal + item.rx.customsTax[0] %}
                        {% endif %}
                    {% endif %}

                    {% if item.rx.igPermitFee is defined and item.rx.igPermitFee[0] * 1 > 0 %}
                      <tr>
                        <td class="border-right">SG Customs IG Permit Fee</td>
                        <td align="right">{{ item.rx.igPermitFee[0]|number_format(2, '.', ',') }}</td>
                      </tr>
                       {% set col3SubTotal = col3SubTotal + item.rx.igPermitFee[0] %}

                    {% endif %}

                    {% if item.rx.paymentGatewayFeeBankMdr[0] != 0 %}
                    <tr>
                      <td class="border-right">Payment Gateway Fee (Bank MDR - CC)</td>
                      <td align="right">{{ item.rx.paymentGatewayFeeBankMdr[0]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeBankGst[2] != 0 %}
                    <tr>
                      <td class="border-right">Payment Gateway Fee (Bank GST)</td>
                      <td align="right">{{ item.rx.paymentGatewayFeeBankGst[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeVariable[0] != 0 %}
                    <tr>
                      <td class="border-right">Payment Gateway Fee (Variable)</td>
                      <td align="right">{{ item.rx.paymentGatewayFeeVariable[0]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeFixed[0] != 0 %}
                    <tr>
                      
                      {% if item.rx.paymentGate == constant('UtilBundle\\Utility\\Constant::PAYMENT_GATE_REDDOT') %}
                        <td class="border-right">Payment Gateway (Fixed Fee)</td>
                      {% else %}
                        <td class="border-right">Payment Gateway Fee (Fixed - FPX)</td>
                      {% endif %}

                      <td align="right">{{ item.rx.paymentGatewayFeeFixed[0]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeFixedGst[2] != 0 %}
                    <tr>
                      <td class="border-right">Payment Gateway Fee (Fixed GST)</td>
                      <td align="right">{{ item.rx.paymentGatewayFeeFixedGst[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}

                     {% set col3SubTotal = col3SubTotal + item.rx.shippingList[0] + item.rx.paymentGatewayFeeBankMdr[0]  + item.rx.paymentGatewayFeeVariable[0] + item.rx.paymentGatewayFeeFixed[0] + item.rx.paymentGatewayFeeBankGst[2]  %}

                    {% set col3SubtotalArea = col3SubtotalArea + col3SubTotal %} 
                </table>
              </td>
            </tr>
            <tr class="subtotal-every">
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="16%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="16%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="26%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="30%"><strong>Subtotal per order</strong></td>
              <td valign="top" align="right" {% if index == last %}class="border-bottom" {% endif %} width="12%"><strong>{{ col3SubTotal|number_format(2, '.', ',') }}</strong></td>
            </tr>
          {% endfor %}
        {% endif %}

        <tr class="subtotal">
          <td valign="top" class="border-bottom" width="16%"></td>
          <td valign="top" class="border-bottom" width="16%"></td>
          <td valign="top" class="border-bottom" width="26%"></td>
          <td valign="top" class="border-bottom" width="30%"><strong>Subtotal ({{ type == 'local' ? 'Local Patients' : 'Overseas Patients' }})</strong></td>
          <td valign="top" align="right" class="border-bottom" width="12%"><strong>{{ col3SubtotalArea |number_format(2, '.', ',')}}</strong></td>
        </tr>
      </tbody>  
    </table>
  </div>
  
</div>
