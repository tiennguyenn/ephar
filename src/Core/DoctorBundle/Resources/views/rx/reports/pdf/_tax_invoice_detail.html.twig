<div class="content">
  <div class="container">
    <h2 class="sub-title">{{ title }}</h2>
    <table class="table-data table-multi-line">
      <thead>
        <tr>
          <th align="left" valign="bottom" width="10%" class="border-bottom">Date of <br> Transaction</th>
          <th align="left" valign="bottom" width="16%" class="border-bottom">Order ID</th>
          <th align="left" valign="bottom" width="16%" class="border-bottom">Patient <br> Name and Code</th>
          <th align="left" valign="bottom" class="border-right border-bottom" width="20%">Prescription Details</th>
          <th align="right" valign="bottom" class="border-right border-bottom" width="8%">GST <br> Code</th>
          <th align="right" valign="bottom" class="border-right border-bottom" width="10%">Amount <br> before GST <br> ({{ currencyCode }})</th>
          <th align="right" valign="bottom" class="border-right border-bottom" width="10%">GST <br> Amount <br> ({{ currencyCode }})</th>
          <th align="right" valign="bottom" width="10%" class="border-bottom">Amount <br> inclusive of <br> GST ({{ currencyCode }})</th>
        </tr>
      </thead>  
      <tbody>
        {% if data is defined %}
          {% set col1SubtotalArea = 0 %}
          {% set col2SubtotalArea = 0 %}
          {% set col3SubtotalArea = 0 %}

          {% for item in data %}
            {% set index = loop.index %}
            {% set last = loop.last %}
            <tr>
              <td valign="top" width="10%">{{ item.rx.paidOn|date('d M Y') }}</td>
              <td valign="top" width="16%">{{ item.rx.orderNumber }}</td>
              <td valign="top" width="16%">                 
                  {{ item.rx.patientCode }}
                  {% if item.rx.taxIncome is not null %}<br>Tax ID: {{ item.rx.taxId }}{% endif %}</td>
              <td colspan="5" class="subdata-wrap">
                <table class="table-subdata">
                    {% set col1SubTotal = 0 %}
                    {% set col2SubTotal = 0 %}
                    {% set col3SubTotal = 0 %}
                    {% for rxLine in item.presDetail %}
                      {% if rxLine.lineType == 2 and rxLine.hasRxReviewFee == true %}
                        {% if platform_share_fee %}
                        <tr>
                            <td class="border-right" width="34.5%">GMedes Admin Service Fee Per Prescription</td>
                            <td class="border-right" width="13.7%" align="right">{{ item.rx.prescribingRevenueFeeGstCode }}</td>
                            <td class="border-right {% if item.rx.serviceFeeTotal < 0 %}txt-red{% endif %}" width="17.3%" align="right">{{ item.rx.serviceFeeTotal|number_format(2, '.', ',') }}</td>
                            <td class="border-right {% if (item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal) < 0 %}txt-red{% endif %}" width="17.2%" align="right">{{ (item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal)|number_format(2, '.', ',') }}</td>

                            <td width="17.3%" align="right" {% if item.rx.prescribingRevenueFeeGst < 0 %}class="txt-red"{% endif %}>{{ item.rx.prescribingRevenueFeeGst|number_format(2, '.', ',') }}</td>
                            {% set col1SubTotal = col1SubTotal + item.rx.serviceFeeTotal %}
                            {% set col2SubTotal = col2SubTotal + item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal %}
                            {% set col3SubTotal = col3SubTotal + item.rx.prescribingRevenueFeeGst %}
                        </tr>
                        {% else %}
                        <tr>
                            <td class="border-right" width="34.5%">Doctor's Fees (Prescribing Fee)</td>
                            <td class="border-right" width="13.7%" align="right">{{ item.rx.prescribingRevenueFeeGstCode }}</td>
                            <td class="border-right {% if item.rx.serviceFeeTotal < 0 %}txt-red{% endif %}" width="17.3%" align="right">{{ item.rx.serviceFeeTotal|number_format(2, '.', ',') }}</td>
                            <td class="border-right {% if (item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal) < 0 %}txt-red{% endif %}" width="17.2%" align="right">{{ (item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal)|number_format(2, '.', ',') }}</td>

                            <td width="17.3%" align="right" {% if item.rx.prescribingRevenueFeeGst < 0 %}class="txt-red"{% endif %}>{{ item.rx.prescribingRevenueFeeGst|number_format(2, '.', ',') }}</td>

                            {% set col1SubTotal = col1SubTotal + item.rx.serviceFeeTotal %}
                            {% set col2SubTotal = col2SubTotal + item.rx.prescribingRevenueFeeGst - item.rx.serviceFeeTotal %}
                            {% set col3SubTotal = col3SubTotal + item.rx.prescribingRevenueFeeGst %}
                        </tr>
                        {% endif %}
                      {% elseif rxLine.lineType == 1 %}
                        {% if platform_share_fee %}
                        <tr>
                              <td class="border-right" width="34.5%">{{ rxLine.name }}</td>
                              <td class="border-right" width="13.7%" align="right">{{ rxLine.gstCode }}</td>
                              <td class="border-right {% if rxLine.costPriceToClinic * rxLine.quantity < 0 %}txt-red{% endif %}" width="17.3%" align="right">{{ (rxLine.costPriceToClinic * rxLine.quantity)|number_format(2, '.', ',') }}</td>
                              <td class="border-right {% if (rxLine.costPriceToClinicNoGST * rxLine.quantity) < 0 %}txt-red{% endif %}" width="17.2%" align="right">{{ (rxLine.costPriceToClinicNoGST * rxLine.quantity)|number_format(2, '.', ',') }}</td>
                              <td width="17.3%" align="right" {% if (rxLine.costPriceToClinicGST * rxLine.quantity) < 0 %} class='txt-red'{% endif %}>{{ (rxLine.costPriceToClinicGST * rxLine.quantity)|number_format(2, '.', ',') }}</td>

                              {% set col1SubTotal = col1SubTotal + rxLine.costPriceToClinic * rxLine.quantity %}
                              {% set col2SubTotal = col2SubTotal + rxLine.costPriceToClinicNoGST * rxLine.quantity %}
                              {% set col3SubTotal = col3SubTotal + rxLine.costPriceToClinicGST * rxLine.quantity %}
                        </tr>
                        {% else %}
                        <tr>
                              <td class="border-right" width="34.5%">{{ rxLine.name }}</td>
                              <td class="border-right" width="13.7%" align="right">{{ rxLine.gstCode }}</td>
                              <td class="border-right {% if rxLine.originPrice * rxLine.quantity < 0 %}txt-red{% endif %}" width="17.3%" align="right">{{ (rxLine.originPrice * rxLine.quantity)|number_format(2, '.', ',') }}</td>
                              <td class="border-right {% if (rxLine.originPriceNoGST * rxLine.quantity) < 0 %}txt-red{% endif %}" width="17.2%" align="right">{{ (rxLine.originPriceNoGST * rxLine.quantity)|number_format(2, '.', ',') }}</td>
                              <td width="17.3%" align="right" {% if (rxLine.originPriceGST * rxLine.quantity) < 0 %} class='txt-red'{% endif %}>{{ (rxLine.originPriceGST * rxLine.quantity)|number_format(2, '.', ',') }}</td>

                              {% set col1SubTotal = col1SubTotal + rxLine.originPrice * rxLine.quantity %}
                              {% set col2SubTotal = col2SubTotal + rxLine.originPriceNoGST * rxLine.quantity %}
                              {% set col3SubTotal = col3SubTotal + rxLine.originPriceGST * rxLine.quantity %}
                        </tr>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                    <tr>
                      <td class="border-right" width="34.5%">Shipping and Handling Fee</td>
                      <td class="border-right" width="13.7%" align="right">{{ item.rx.shippingList[3] }}</td>
                      <td class="border-right" width="17.3%" align="right">{{ item.rx.shippingList[0]|number_format(2, '.', ',') }}</td>
                      <td class="border-right" width="17.2%" align="right">{{ item.rx.shippingList[1]|number_format(2, '.', ',') }}</td>
                      <td width="17.3%" align="right">{{ item.rx.shippingList[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% if type == 'overSea' and item.rx.customCAF[0] * 1 > 0 %}
                      <tr>
                        <td class="border-right" width="34.5%">Customs Clearance Admin Fee - {{item.rx.countryCode == 'ID' ? 'INDO' : item.rx.countryCode}}</td>
                        <td class="border-right" width="13.7%" align="right">{{ item.rx.customCAF[3] }}</td>
                        <td class="border-right" width="17.3%" align="right">{{ item.rx.customCAF[0]|number_format(2, '.', ',') }}</td>
                        <td class="border-right" width="17.2%" align="right">{{ item.rx.customCAF[1]|number_format(2, '.', ',') }}</td>
                        <td width="17.3%" align="right">{{ item.rx.customCAF[2]|number_format(2, '.', ',') }}</td>
                      </tr>
                       {% set col1SubTotal = col1SubTotal + item.rx.customCAF[0] %}
                       {% set col2SubTotal = col2SubTotal + item.rx.customCAF[1] %}
                       {% set col3SubTotal = col3SubTotal + item.rx.customCAF[2] %}
                    {% endif %}
                    {% if item.rx.customsTax[0] * 1 > 0 %}
                        {% if item.rx.taxIncome is not null or item.rx.taxIncomeWithoutTax is not null %}
                            <tr>
                                <td class="border-right" width="34.5%">BM - Import Duty</td>
                                <td class="border-right" width="13.7%" align="right">{{ item.rx.customsTax[3] }}</td>
                                <td class="border-right" width="17.3%" align="right">{{ item.rx.importDuty|number_format(2, '.', ',') }}</td>
                                <td class="border-right" width="17.2%" align="right">{{ (item.rx.importDuty * item.rx.gstRate)|number_format(2, '.', ',') }}</td>
                                <td width="17.3%" align="right">{{ (item.rx.importDuty + (item.rx.importDuty * item.rx.gstRate))|number_format(2, '.', ',') }}</td>
                            </tr>
                            <tr>
                                <td class="border-right" width="34.5%">PPN - VAT</td>
                                <td class="border-right" width="13.7%" align="right">{{ item.rx.customsTax[3] }}</td>
                                <td class="border-right" width="17.3%" align="right">{{ item.rx.taxVat|number_format(2, '.', ',') }}</td>
                                <td class="border-right" width="17.2%" align="right">{{ (item.rx.taxVat * item.rx.gstRate)|number_format(2, '.', ',') }}</td>
                                <td width="17.3%" align="right">{{ (item.rx.taxVat + (item.rx.taxVat * item.rx.gstRate))|number_format(2, '.', ',') }}</td>
                            </tr>
                            {% if item.rx.taxIncome is not null %}
                                {% set label = 'PPH1 - Tax on Import (for individuals with TAX ID)' %}
                                {% set pph = item.rx.taxIncome %}
                            {% else %}
                                {% set label = 'PPH2 - Tax on Import (for individuals without TAX ID)' %}
                                {% set pph = item.rx.taxIncomeWithoutTax %}
                            {% endif %}
                            <tr>
                                <td class="border-right" width="34.5%">{{ label }}</td>
                                <td class="border-right" width="13.7%" align="right">{{ item.rx.customsTax[3] }}</td>
                                <td class="border-right" width="17.3%" align="right">{{ pph|number_format(2, '.', ',') }}</td>
                                <td class="border-right" width="17.2%" align="right">{{ (pph * item.rx.gstRate)|number_format(2, '.', ',') }}</td>
                                <td width="17.3%" align="right">{{ (pph + (pph * item.rx.gstRate))|number_format(2, '.', ',') }}</td>
                            </tr>
                          {% set col1SubTotal = col1SubTotal + pph + item.rx.taxVat + item.rx.importDuty  %}
                          {% set col2SubTotal = col2SubTotal + (pph * item.rx.gstRate) + (item.rx.taxVat * item.rx.gstRate) + (item.rx.importDuty * item.rx.gstRate) %}
                          {% set col3SubTotal = col3SubTotal + (pph + (pph * item.rx.gstRate)) + (item.rx.taxVat + (item.rx.taxVat * item.rx.gstRate)) + (item.rx.importDuty + (item.rx.importDuty * item.rx.gstRate)) %}
                        {% else %}
                          <tr>
                            <td class="border-right" width="34.5%">{{ item.rx.customsTaxName }}</td>
                            <td class="border-right" width="13.7%" align="right">{{ item.rx.customsTax[3] }}</td>
                            <td class="border-right" width="17.3%" align="right">{{ item.rx.customsTax[0]|number_format(2, '.', ',') }}</td>
                            <td class="border-right" width="17.2%" align="right">{{ item.rx.customsTax[1]|number_format(2, '.', ',') }}</td>
                            <td width="17.3%" align="right">{{ item.rx.customsTax[2]|number_format(2, '.', ',') }}</td>
                          </tr>
                        {% set col1SubTotal = col1SubTotal + item.rx.customsTax[0] %}
                        {% set col2SubTotal = col2SubTotal + item.rx.customsTax[1] %}
                        {% set col3SubTotal = col3SubTotal + item.rx.customsTax[2] %}
                        {% endif %}
                    {% endif %}

                    {% if item.rx.igPermitFee is defined and item.rx.igPermitFee[0] * 1 > 0 %}
                     <tr>
                        <td class="border-right" width="34.5%">SG Customs IG Permit Fee</td>
                        <td class="border-right" width="13.7%" align="right">{{ item.rx.igPermitFee[3] }}</td>
                        <td class="border-right" width="17.3%" align="right">{{ item.rx.igPermitFee[0]|number_format(2, '.', ',') }}</td>
                        <td class="border-right" width="17.2%" align="right">{{ item.rx.igPermitFee[1]|number_format(2, '.', ',') }}</td>
                        <td width="17.3%" align="right">{{ item.rx.igPermitFee[2]|number_format(2, '.', ',') }}</td>
                     </tr>
                     {% set col1SubTotal = col1SubTotal + item.rx.igPermitFee[0] %}
                     {% set col2SubTotal = col2SubTotal + item.rx.igPermitFee[1] %}
                     {% set col3SubTotal = col3SubTotal + item.rx.igPermitFee[2] %}
                   {% endif %}
                   {% if item.rx.paymentGatewayFeeBankMdr[0] != 0 %}
                    <tr>
                      <td class="border-right" width="34.5%">Payment Gateway Fee (Bank MDR - CC)</td>
                      <td class="border-right" width="13.7%" align="right">{{ item.rx.paymentGatewayFeeBankMdr[3] }}</td>
                      <td class="border-right" width="17.3%" align="right">{{ item.rx.paymentGatewayFeeBankMdr[0]|number_format(2, '.', ',') }}</td>
                      <td class="border-right" width="17.2%" align="right">{{ item.rx.paymentGatewayFeeBankMdr[1]|number_format(2, '.', ',') }}</td>
                      <td width="17.3%" align="right">{{ item.rx.paymentGatewayFeeBankMdr[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeVariable[0] != 0 %}
                    <tr>
                      <td class="border-right" width="34.5%">Payment Gateway Fee (Variable)</td>
                      <td class="border-right" width="13.7%" align="right">{{ item.rx.paymentGatewayFeeVariable[3] }}</td>
                      <td class="border-right" width="17.3%" align="right">{{ item.rx.paymentGatewayFeeVariable[0]|number_format(2, '.', ',') }}</td>
                      <td class="border-right" width="17.2%" align="right">{{ item.rx.paymentGatewayFeeVariable[1]|number_format(2, '.', ',') }}</td>
                      <td width="17.3%" align="right">{{ item.rx.paymentGatewayFeeVariable[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}
                    {% if item.rx.paymentGatewayFeeFixed[0] != 0 %}
                    <tr>
                      {% if item.rx.paymentGate == constant('UtilBundle\\Utility\\Constant::PAYMENT_GATE_REDDOT') %}
                        <td class="border-right" width="34.5%">Payment Gateway (Fixed Fee)</td>
                      {% else %}
                        <td class="border-right" width="34.5%">Payment Gateway Fee (Fixed -FPX)</td>
                      {% endif %}
                      <td class="border-right" width="13.7%" align="right">{{ item.rx.paymentGatewayFeeFixed[3] }}</td>
                      <td class="border-right" width="17.3%" align="right">{{ item.rx.paymentGatewayFeeFixed[0]|number_format(2, '.', ',') }}</td>
                      <td class="border-right" width="17.2%" align="right">{{ item.rx.paymentGatewayFeeFixed[1]|number_format(2, '.', ',') }}</td>
                      <td width="17.3%" align="right">{{ item.rx.paymentGatewayFeeFixed[2]|number_format(2, '.', ',') }}</td>
                    </tr>
                    {% endif %}

                     {% set col1SubTotal = col1SubTotal + item.rx.shippingList[0] + item.rx.paymentGatewayFeeBankMdr[0] + item.rx.paymentGatewayFeeVariable[0] + item.rx.paymentGatewayFeeFixed[0] %}

                     {% set col2SubTotal = col2SubTotal + item.rx.shippingList[1] + item.rx.paymentGatewayFeeBankMdr[1] + item.rx.paymentGatewayFeeVariable[1] + item.rx.paymentGatewayFeeFixed[1]  %}

                     {% set col3SubTotal = col3SubTotal + item.rx.shippingList[2] + item.rx.paymentGatewayFeeBankMdr[2]  + item.rx.paymentGatewayFeeVariable[2] + item.rx.paymentGatewayFeeFixed[2]  %}

                    {% set col1SubtotalArea = col1SubtotalArea + col1SubTotal %} 
                    {% set col2SubtotalArea = col2SubtotalArea + col2SubTotal %} 
                    {% set col3SubtotalArea = col3SubtotalArea + col3SubTotal %} 
                </table>
              </td>
            </tr>
            <tr class="subtotal-every">
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="10%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="16%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="16%"></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="20%"><strong>Subtotal per order</strong></td>
              <td valign="top" {% if index == last %}class="border-bottom" {% endif %} width="8%"></td>
              <td valign="top" align="right" {% if index == last %}class="border-bottom" {% endif %} width="10%"><strong>{{ col1SubTotal|number_format(2, '.', ',') }}</strong></td>
              <td valign="top" align="right" {% if index == last %}class="border-bottom" {% endif %} width="10%"><strong>{{ col2SubTotal|number_format(2, '.', ',') }}</strong></td>
              <td valign="top" align="right" {% if index == last %}class="border-bottom" {% endif %} width="10%"><strong>{{ col3SubTotal|number_format(2, '.', ',') }}</strong></td>
            </tr>
          {% endfor %}
        {% endif %}

        <tr class="subtotal">
          <td valign="top" class="border-bottom" width="10%"></td>
          <td valign="top" class="border-bottom" width="16%"></td>
          <td valign="top" class="border-bottom" width="16%"></td>
          <td valign="top" class="border-bottom" width="20%"><strong>Subtotal ({{ type == 'local' ? 'Local Patients' : 'Overseas Patients' }})</strong></td>
          <td valign="top" class="border-bottom" width="8%"></td>
          <td valign="top" align="right" class="border-bottom" width="10%"><strong>{{ col1SubtotalArea |number_format(2, '.', ',')}}</strong></td>
          <td valign="top" align="right" class="border-bottom" width="10%"><strong>{{ col2SubtotalArea |number_format(2, '.', ',')}}</strong></td>
          <td valign="top" align="right" class="border-bottom" width="10%"><strong>{{ col3SubtotalArea |number_format(2, '.', ',')}}</strong></td>
        </tr>
      </tbody>  
    </table>
  </div>
  
</div>
